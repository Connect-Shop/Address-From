<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Shopping</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts for a luxury feel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <!-- LINE LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; background-color: #f8f8f8; }
        .font-display { font-family: 'Playfair Display', serif; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 50; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-backdrop.show { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 450px; text-align: center; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-backdrop.show .modal-content { transform: scale(1); }
        .payment-option { display: none; }
        .payment-option.active { display: block; animation: fadeIn 0.3s; }
        .gemini-button { background: linear-gradient(135deg, #8A2BE2 0%, #4B0082 100%); }
    </style>
</head>
<body class="text-gray-800">

    <div id="app-container" class="max-w-lg mx-auto bg-white shadow-lg min-h-screen">
        <!-- Header -->
        <header class="sticky top-0 bg-white/90 backdrop-blur-md z-40 p-4 shadow-sm flex justify-between items-center">
            <div>
                <button id="back-button" class="hidden mr-2 text-xl" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
                <h1 id="header-title" class="text-2xl font-bold font-display text-gray-900 inline-block">Store Shopping</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="navigateTo('history-view')" class="text-xl text-gray-600"><i class="fas fa-history"></i></button>
                <div class="relative cursor-pointer" onclick="navigateTo('cart-view')">
                    <i class="fas fa-shopping-cart text-xl text-gray-600"></i>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </div>
            </div>
        </header>

        <main class="p-4">
            <!-- Home View -->
            <div id="home-view" class="view active">
                <button onclick="showPersonalShopperModal()" class="w-full py-3 px-4 mb-6 rounded-full gemini-button text-white font-bold shadow-lg transition-transform transform hover:scale-105">
                    ✨ ผู้ช่วยช็อปปิ้งส่วนตัว
                </button>
                <h2 class="text-2xl font-bold mb-4">สินค้าทั้งหมด</h2>
                <div id="loading" class="text-center py-10"><i class="fas fa-spinner fa-spin text-4xl text-purple-500"></i></div>
                <div id="product-grid" class="grid grid-cols-2 gap-4"></div>
            </div>

            <!-- Cart View -->
            <div id="cart-view" class="view">
                 <!-- ... (same as before) ... -->
                <h2 class="text-2xl font-bold mb-4">ตะกร้าสินค้า</h2>
                <div id="cart-items-container"></div>
                <div id="cart-summary" class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <div class="flex justify-between font-bold text-lg">
                        <span>ยอดรวม</span>
                        <span id="cart-total">0 ฿</span>
                    </div>
                    <button id="checkout-button" onclick="navigateTo('checkout-view')" class="mt-4 w-full bg-gray-800 text-white py-3 rounded-lg font-bold hover:bg-gray-900 disabled:bg-gray-400">ไปที่หน้าชำระเงิน</button>
                </div>
            </div>

            <!-- Checkout View -->
            <div id="checkout-view" class="view">
                <!-- ... (same as before) ... -->
                <h2 class="text-2xl font-bold mb-4">ชำระเงิน</h2>
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold mb-2">ข้อมูลการจัดส่ง</h3>
                        <input id="co-name" type="text" placeholder="ชื่อ-นามสกุล" class="w-full p-2 border rounded">
                        <input id="co-address" type="text" placeholder="ที่อยู่" class="w-full p-2 border rounded mt-2">
                        <input id="co-phone" type="tel" placeholder="เบอร์โทรศัพท์" class="w-full p-2 border rounded mt-2">
                    </div>
                    <div>
                        <h3 class="font-bold mb-2">ช่องทางการชำระเงิน</h3>
                        <select id="co-payment" class="w-full p-2 border rounded">
                            <option value="promptpay">พร้อมเพย์ (PromptPay QR)</option>
                            <option value="bank">โอนผ่านธนาคาร</option>
                            <option value="truemoney">ทรูมันนี่ วอลเล็ท</option>
                            <option value="linepay">LINE Pay</option>
                        </select>
                    </div>
                    <div id="payment-bank" class="payment-option p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-bold mb-2">เลือกธนาคาร:</h4>
                        <select id="co-bank-list" class="w-full p-2 border rounded"></select>
                        <div id="bank-account-details" class="mt-4 text-left bg-white p-3 rounded"></div>
                    </div>
                    <div id="payment-promptpay" class="payment-option active p-4 bg-green-50 rounded-lg text-center">
                        <p>ระบบจะสร้าง QR Code สำหรับสแกนจ่ายในขั้นตอนถัดไป</p>
                    </div>
                    <div id="payment-truemoney" class="payment-option p-4 bg-orange-50 rounded-lg text-center">
                        <p>ระบบจะพาคุณไปยังแอป TrueMoney Wallet เพื่อชำระเงิน</p>
                    </div>
                    <div id="payment-linepay" class="payment-option p-4 bg-teal-50 rounded-lg text-center">
                        <p>ระบบจะเปิดหน้าชำระเงินของ LINE Pay</p>
                    </div>
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg font-bold">
                        <div class="flex justify-between"><span>ยอดรวมสินค้า</span><span id="co-subtotal">0 ฿</span></div>
                        <div class="flex justify-between text-xl"><span>ยอดสุทธิ</span><span id="co-total">0 ฿</span></div>
                    </div>
                    <button id="confirm-order-btn" onclick="placeOrder()" class="mt-4 w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700">ยืนยันและดำเนินการต่อ</button>
                </div>
            </div>

            <!-- Confirmation View -->
            <div id="confirmation-view" class="view text-center py-10">
                <!-- ... (same as before) ... -->
                <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                <h2 class="text-2xl font-bold mb-2">สั่งซื้อสำเร็จ!</h2>
                <p class="text-gray-600 mb-6">เราได้ส่งสรุปรายการสั่งซื้อไปให้คุณทาง LINE แล้ว</p>
                <p class="mb-2">Order ID: <span id="conf-order-id" class="font-mono"></span></p>
                <button onclick="navigateTo('home-view', true)" class="mt-4 bg-gray-800 text-white py-3 px-6 rounded-lg font-bold">กลับสู่หน้าแรก</button>
            </div>
            
            <!-- History View -->
            <div id="history-view" class="view">
                 <!-- ... (same as before) ... -->
                <h2 class="text-2xl font-bold mb-4">ประวัติการสั่งซื้อ</h2>
                <div id="history-container" class="space-y-4"></div>
            </div>
        </main>
    </div>

    <!-- Modal for dynamic content -->
    <div id="custom-modal" class="modal-backdrop"><div class="modal-content" id="modal-content-main"></div></div>
    
    <script>
        // --- CONFIGURATION ---
        const LIFF_ID = "https://liff.line.me/2008007164-WQZgwbkj"; // ❗️ PASTE YOUR LIFF ID HERE
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyA0tyomy5fsB-twVlyspcsww7Dv6LTc5J2F540KwN9wOonFOkJnRlZIg0Unj_40-sdug/exec"; // ❗️ PASTE YOUR GOOGLE APPS SCRIPT URL HERE
        const GEMINI_API_KEY = ""; // ❗️ Leave this empty. Canvas will provide it.
        const PROMPT_PAY_ID = "140000811606998"; 
        const BANK_ACCOUNTS = [ 
            { name: "ธนาคารกสิกรไทย", value: "kbank", number: "123-4-56789-0", owner: "ชื่อบัญชี" },
            { name: "ธนาคารไทยพาณิชย์", value: "scb", number: "987-6-54321-0", owner: "ชื่อบัญชี" },
            { name: "ธนาคารกรุงเทพ", value: "bbl", number: "111-2-33344-5", owner: "ชื่อบัญชี" },
            { name: "ธนาคารกรุงไทย", value: "ktb", number: "555-6-77788-9", owner: "ชื่อบัญชี" },
            { name: "ธนาคารกรุงศรีอยุธยา", value: "bay", number: "246-8-13579-0", owner: "ชื่อบัญชี" },
            { name: "ธนาคารทหารไทยธนชาต", value: "ttb", number: "001-9-88776-5", owner: "ชื่อบัญชี" },
        ];
        
        // --- APP STATE ---
        let allProducts = [];
        let cart = [];
        let liffProfile = null;
        let viewHistory = ['home-view'];
        
        // --- DOM ELEMENTS ---
        const cartCountEl = document.getElementById('cart-count');
        const headerTitleEl = document.getElementById('header-title');
        const backButtonEl = document.getElementById('back-button');

        // --- VIEW NAVIGATION (same as before) ---
        function navigateTo(viewId, isReset = false) { 
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            if (isReset) { viewHistory = ['home-view']; } 
            else { if(viewHistory[viewHistory.length - 1] !== viewId) viewHistory.push(viewId); }
            updateUI();
        }
        function goBack() { 
            if (viewHistory.length > 1) {
                viewHistory.pop();
                const prevViewId = viewHistory[viewHistory.length - 1];
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(prevViewId).classList.add('active');
                updateUI();
            }
        }
        function updateUI() {
            renderCart();
            updateCartCount();
            updateHeader();
            if (document.getElementById('checkout-view').classList.contains('active')) {
                updateCheckoutSummary();
            }
            if (document.getElementById('history-view').classList.contains('active')) {
                fetchOrderHistory();
            }
        }
        function updateHeader() {
            const currentView = viewHistory[viewHistory.length - 1];
            backButtonEl.classList.toggle('hidden', currentView === 'home-view');
            const viewTitles = { 'home-view': 'Store Shopping', 'cart-view': 'ตะกร้าสินค้า', 'checkout-view': 'ชำระเงิน', 'confirmation-view': 'ยืนยันการสั่งซื้อ', 'history-view': 'ประวัติการสั่งซื้อ'};
            headerTitleEl.textContent = viewTitles[currentView] || 'Store Shopping';
        }

        // --- CART LOGIC (same as before) ---
        function addToCart(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) { cartItem.quantity++; } 
            else { cart.push({ ...product, quantity: 1 }); }
            showModalMessage('✅', 'เพิ่มสินค้าแล้ว', `"${product.name}" ถูกเพิ่มลงในตะกร้า`);
            updateUI();
        }
        function updateCartQuantity(productId, change) {
            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) {
                cartItem.quantity += change;
                if (cartItem.quantity <= 0) cart = cart.filter(item => item.id !== productId);
            }
            updateUI();
        }
        function renderCart() {
            const container = document.getElementById('cart-items-container');
            const summaryEl = document.getElementById('cart-summary');
            if (cart.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">ตะกร้าของคุณว่างเปล่า</p>';
                summaryEl.classList.add('hidden'); return;
            }
            summaryEl.classList.remove('hidden');
            container.innerHTML = cart.map(item => `<div class="flex items-center gap-4 border-b py-4"><img src="${item.image}" class="w-20 h-20 object-cover rounded-md"><div class="flex-grow"><p class="font-bold">${item.name}</p><p class="text-gray-600">${item.price.toLocaleString()} ฿</p></div><div class="flex items-center gap-2"><button onclick="updateCartQuantity(${item.id}, -1)" class="w-8 h-8 bg-gray-200 rounded-full font-bold">-</button><span>${item.quantity}</span><button onclick="updateCartQuantity(${item.id}, 1)" class="w-8 h-8 bg-gray-200 rounded-full font-bold">+</button></div></div>`).join('');
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('cart-total').textContent = `${total.toLocaleString()} ฿`;
            document.getElementById('checkout-button').disabled = cart.length === 0;
        }
        function updateCartCount() { cartCountEl.textContent = cart.reduce((sum, item) => sum + item.quantity, 0); }

        // --- CHECKOUT & PAYMENT LOGIC (same as before) ---
        function setupCheckoutPage() {
            const bankList = document.getElementById('co-bank-list');
            bankList.innerHTML = '';
            BANK_ACCOUNTS.forEach(bank => {
                const option = document.createElement('option');
                option.value = bank.value; option.textContent = bank.name;
                bankList.appendChild(option);
            });
            bankList.addEventListener('change', updateBankAccountDetails);
            document.getElementById('co-payment').addEventListener('change', updatePaymentOptionView);
            updateBankAccountDetails(); updatePaymentOptionView();
        }
        function updatePaymentOptionView() {
            const selectedMethod = document.getElementById('co-payment').value;
            document.querySelectorAll('.payment-option').forEach(el => el.classList.remove('active'));
            document.getElementById(`payment-${selectedMethod}`).classList.add('active');
        }
        function updateBankAccountDetails() {
            const selectedBankValue = document.getElementById('co-bank-list').value;
            const bank = BANK_ACCOUNTS.find(b => b.value === selectedBankValue);
            if (bank) { document.getElementById('bank-account-details').innerHTML = `<p><strong>ธนาคาร:</strong> ${bank.name}</p><p><strong>เลขที่บัญชี:</strong> ${bank.number}</p><p><strong>ชื่อบัญชี:</strong> ${bank.owner}</p>`; }
        }
        function updateCheckoutSummary() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('co-subtotal').textContent = `${subtotal.toLocaleString()} ฿`;
            document.getElementById('co-total').textContent = `${subtotal.toLocaleString()} ฿`;
        }
        async function placeOrder() {
            if (cart.length === 0) return;
            const paymentMethod = document.getElementById('co-payment').value;
            const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const orderData = { lineUserId: liffProfile?.userId, lineDisplayName: liffProfile?.displayName, items: cart.map(item => ({id: item.id, name: item.name, quantity: item.quantity, price: item.price})), shippingAddress: { name: document.getElementById('co-name').value, address: document.getElementById('co-address').value, phone: document.getElementById('co-phone').value }, paymentMethod: paymentMethod, totalAmount: totalAmount };
            if (!orderData.shippingAddress.name || !orderData.shippingAddress.address || !orderData.shippingAddress.phone) { showModalMessage('❗️', 'ข้อมูลไม่ครบถ้วน', 'กรุณากรอกข้อมูลการจัดส่งให้ครบถ้วน'); return; }
            showModalMessage('⏳', 'กำลังดำเนินการ', 'กำลังสร้างคำสั่งซื้อของคุณ...');
            const savedOrder = await saveOrderToGAS(orderData);
            hideModal();
            if (!savedOrder || !savedOrder.success) { showModalMessage('❗️', 'เกิดข้อผิดพลาด', savedOrder.error || 'ไม่สามารถบันทึกคำสั่งซื้อได้'); return; }
            if (paymentMethod === 'promptpay') { showPromptPayQR(totalAmount, savedOrder.orderId); } 
            else if (paymentMethod === 'bank') { document.getElementById('conf-order-id').textContent = savedOrder.orderId; navigateTo('confirmation-view'); } 
            else if (paymentMethod === 'truemoney') { const trueMoneyURL = `https://www.truemoney.com/payment?ref=${savedOrder.orderId}&amount=${totalAmount}`; liff.openWindow({ url: trueMoneyURL, external: true }); } 
            else if (paymentMethod === 'linepay') { showModalMessage('💸', 'กำลังไปยัง LINE Pay', 'ฟังก์ชันนี้ต้องเชื่อมต่อ API จริงจากฝั่งเซิร์ฟเวอร์'); }
            cart = []; updateUI();
        }
        function showPromptPayQR(amount, orderId) { /* ... (same as before) ... */ 
             const generatePayload = (pointOfInitiation, merchantIdentifier, amount) => { const formatMerchantIdentifier = (type, value) => { const tag = type === 'phone' ? '01' : '02'; const formattedValue = type === 'phone' ? `0066${value.substring(1)}` : value; return `29${(tag.length + value.length + 8).toString().padStart(2, '0')}${tag}13${formattedValue}`; }; const payload = [ '000201', `0102${pointOfInitiation}`, formatMerchantIdentifier('phone', merchantIdentifier), '5802TH', `5303764`, `54${amount.toFixed(2).length.toString().padStart(2, '0')}${amount.toFixed(2)}`, '6304' ]; const data = payload.join(''); let crc = 0xFFFF; for (let i = 0; i < data.length; i++) { crc ^= data.charCodeAt(i) << 8; for (let j = 0; j < 8; j++) { crc = (crc & 0x8000) ? (crc << 1) ^ 0x1021 : crc << 1; } } return data + (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0'); }; const qrPayload = generatePayload('12', PROMPT_PAY_ID, amount); const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(qrPayload)}`; const content = `<div class="text-center"><h3 class="text-xl font-bold font-display mb-2">สแกนเพื่อชำระเงิน</h3><p>Order ID: ${orderId}</p><img src="${qrUrl}" alt="PromptPay QR Code" class="mx-auto my-4 border rounded-lg"><p class="font-bold text-2xl">${amount.toLocaleString()} ฿</p><p class="text-sm text-gray-500 mt-2">เมื่อชำระแล้ว กรุณาส่งหลักฐานการโอนเงินให้แอดมิน</p><button onclick="navigateTo('home-view', true); hideModal();" class="mt-4 w-full bg-gray-800 text-white py-3 rounded-lg font-bold">ดำเนินการเสร็จสิ้น</button></div>`; showModalContent(content);
        }
        async function saveOrderToGAS(orderData) {
            try { const response = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'createOrder', payload: orderData }), headers: { 'Content-Type': 'application/json' } }); return await response.json(); } catch (error) { return { success: false, error: error.message }; }
        }
        
        // --- DATA & HISTORY (same as before) ---
        async function fetchProducts() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('product-grid').innerHTML = '';
             try {
                const response = await fetch(`${GAS_URL}?action=getProducts`);
                const data = await response.json();
                if (data.products && data.products.length > 0) { allProducts = data.products; renderProducts(allProducts); } 
                else { throw new Error('No products found'); }
            } catch (error) { renderProducts([]); showModalMessage('❗️', 'ข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลสินค้าได้'); } 
            finally { document.getElementById('loading').style.display = 'none'; }
        }
        function renderProducts(products) {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = products.map(p => `
                <div class="bg-white border rounded-lg shadow-sm overflow-hidden flex flex-col">
                    <img src="${p.image}" alt="${p.name}" class="w-full h-40 object-cover">
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="font-semibold text-md truncate flex-grow">${p.name}</h3>
                        <p class="text-purple-600 font-bold mt-1">${p.price.toLocaleString()} ฿</p>
                        <div class="flex space-x-2 mt-3">
                            <button onclick="addToCart(${p.id})" class="flex-grow bg-gray-800 text-white py-2 rounded-lg text-sm font-bold hover:bg-gray-900">เพิ่ม</button>
                            <button onclick="handleStylingAssistant(${p.id})" class="w-10 gemini-button text-white rounded-lg text-sm font-bold flex items-center justify-center" title="แนะนำสไตล์">✨</button>
                        </div>
                    </div>
                </div>`).join('');
        }
        async function fetchOrderHistory() { /* ... (same as before) ... */ }

        // --- GEMINI API INTEGRATION ---
        async function callGeminiApi(prompt) {
            showModalMessage('⏳', 'AI กำลังคิด...', 'กรุณารอสักครู่...');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    return text;
                } else {
                    throw new Error("No response text from API.");
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                showModalMessage('❗️', 'เกิดข้อผิดพลาด', 'ไม่สามารถเรียกใช้ผู้ช่วย AI ได้ในขณะนี้');
                return null;
            }
        }

        function showPersonalShopperModal() {
            const content = `
                <div class="text-center">
                    <h3 class="text-2xl font-bold font-display mb-4">✨ ผู้ช่วยช็อปปิ้งส่วนตัว</h3>
                    <p class="text-gray-600 mb-4">บอกเราว่าคุณกำลังมองหาอะไร แล้ว AI จะช่วยแนะนำสินค้าให้คุณ</p>
                    <textarea id="shopper-input" class="w-full h-24 p-2 border rounded" placeholder="เช่น หาของขวัญวันเกิดให้เพื่อนผู้ชาย, ชุดไปทะเล, ของแต่งบ้านสไตล์มินิมอล..."></textarea>
                    <button onclick="handlePersonalShopperSubmit()" class="mt-4 w-full gemini-button text-white py-3 rounded-lg font-bold">ค้นหาไอเดีย</button>
                </div>
            `;
            showModalContent(content);
        }

        async function handlePersonalShopperSubmit() {
            const userInput = document.getElementById('shopper-input').value;
            if (!userInput.trim()) {
                alert("กรุณาป้อนข้อมูลที่ต้องการค้นหา");
                return;
            }

            const productListText = allProducts.map((p, i) => `${i + 1}. ชื่อ: ${p.name}, รายละเอียด: ${p.description}, ราคา: ${p.price} บาท`).join('\n');
            const prompt = `คุณคือผู้ช่วยช็อปปิ้ง AI อัจฉริยะของร้าน 'Store Shopping' นี่คือรายการสินค้าทั้งหมดที่มีในร้าน:\n${productListText}\n\nลูกค้าร้องขอว่า: "${userInput}"\n\nจากรายการสินค้าที่มี ช่วยแนะนำสินค้าที่ตรงกับความต้องการของลูกค้ามากที่สุด 3 ชิ้น พร้อมบอกเหตุผลสั้นๆ ว่าทำไมถึงแนะนำสินค้าชิ้นนั้น ตอบเป็นภาษาไทย`;

            const result = await callGeminiApi(prompt);
            if (result) {
                showModalMessage('✨', 'ไอเดียจากผู้ช่วย AI', result);
            }
        }

        async function handleStylingAssistant(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            const prompt = `คุณคือสไตลิสต์แฟชั่น สำหรับสินค้าชื่อ '${product.name}' (รายละเอียด: ${product.description}) ช่วยแนะนำไอเดียการแต่งตัวหรือการนำไปใช้งาน 3 ข้อแบบสร้างสรรค์ ตอบกลับเป็นภาษาไทยในรูปแบบรายการ`;

            const result = await callGeminiApi(prompt);
            if (result) {
                showModalMessage('💡', `ไอเดียสำหรับ "${product.name}"`, result);
            }
        }

        // --- MODAL LOGIC ---
        const modal = document.getElementById('custom-modal');
        function showModalMessage(icon, title, message) {
            const content = `<div class="text-left"><div class="text-center text-5xl mb-4">${icon}</div><h3 class="text-center text-2xl font-bold font-display mb-2">${title}</h3><div class="text-gray-600 mb-6 whitespace-pre-wrap">${message.replace(/\n/g, '<br>')}</div><button onclick="hideModal()" class="mt-4 w-full bg-gray-800 text-white py-3 rounded-lg font-bold">ปิด</button></div>`;
            showModalContent(content);
        }
        function showModalContent(htmlContent) {
            document.getElementById('modal-content-main').innerHTML = htmlContent;
            modal.classList.add('show');
        }
        function hideModal() { modal.classList.remove('show'); }
        
        // --- LIFF & APP INITIALIZATION ---
        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login({ redirectUri: window.location.href }); return;
                }
                liffProfile = await liff.getProfile();
                document.getElementById('co-name').value = liffProfile.displayName;
            } catch (error) { showModalMessage('❗️', 'LIFF Error', `Failed to initialize LIFF: ${error.message}`); }
            await fetchProducts();
            setupCheckoutPage();
            updateUI();
        }
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Shopping</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts for a luxury feel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <!-- LINE LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; background-color: #f8f8f8; }
        .font-display { font-family: 'Playfair Display', serif; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 50; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-backdrop.show { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 450px; text-align: center; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-backdrop.show .modal-content { transform: scale(1); }
        .payment-option { display: none; }
        .payment-option.active { display: block; animation: fadeIn 0.3s; }
        .gemini-button { background: linear-gradient(135deg, #8A2BE2 0%, #4B0082 100%); }
    </style>
</head>
<body class="text-gray-800">

    <div id="app-container" class="max-w-lg mx-auto bg-white shadow-lg min-h-screen">
        <!-- Header -->
        <header class="sticky top-0 bg-white/90 backdrop-blur-md z-40 p-4 shadow-sm flex justify-between items-center">
            <div>
                <button id="back-button" class="hidden mr-2 text-xl" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
                <h1 id="header-title" class="text-2xl font-bold font-display text-gray-900 inline-block">Store Shopping</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="navigateTo('history-view')" class="text-xl text-gray-600"><i class="fas fa-history"></i></button>
                <div class="relative cursor-pointer" onclick="navigateTo('cart-view')">
                    <i class="fas fa-shopping-cart text-xl text-gray-600"></i>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </div>
            </div>
        </header>

        <main class="p-4">
            <!-- Home View -->
            <div id="home-view" class="view active">
                <button onclick="showPersonalShopperModal()" class="w-full py-3 px-4 mb-6 rounded-full gemini-button text-white font-bold shadow-lg transition-transform transform hover:scale-105">
                    ‚ú® ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
                </button>
                <h2 class="text-2xl font-bold mb-4">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <div id="loading" class="text-center py-10"><i class="fas fa-spinner fa-spin text-4xl text-purple-500"></i></div>
                <div id="product-grid" class="grid grid-cols-2 gap-4"></div>
            </div>

            <!-- Cart View -->
            <div id="cart-view" class="view">
                 <!-- ... (same as before) ... -->
                <h2 class="text-2xl font-bold mb-4">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                <div id="cart-items-container"></div>
                <div id="cart-summary" class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <div class="flex justify-between font-bold text-lg">
                        <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
                        <span id="cart-total">0 ‡∏ø</span>
                    </div>
                    <button id="checkout-button" onclick="navigateTo('checkout-view')" class="mt-4 w-full bg-gray-800 text-white py-3 rounded-lg font-bold hover:bg-gray-900 disabled:bg-gray-400">‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
                </div>
            </div>

            <!-- Checkout View -->
            <div id="checkout-view" class="view">
                <!-- ... (same as before) ... -->
                <h2 class="text-2xl font-bold mb-4">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h3>
                        <input id="co-name" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full p-2 border rounded">
                        <input id="co-address" type="text" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà" class="w-full p-2 border rounded mt-2">
                        <input id="co-phone" type="tel" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="w-full p-2 border rounded mt-2">
                    </div>
                    <div>
                        <h3 class="font-bold mb-2">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
                        <select id="co-payment" class="w-full p-2 border rounded">
                            <option value="promptpay">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå (PromptPay QR)</option>
                            <option value="bank">‡πÇ‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</option>
                            <option value="truemoney">‡∏ó‡∏£‡∏π‡∏°‡∏±‡∏ô‡∏ô‡∏µ‡πà ‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡πá‡∏ó</option>
                            <option value="linepay">LINE Pay</option>
                        </select>
                    </div>
                    <div id="payment-bank" class="payment-option p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-bold mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</h4>
                        <select id="co-bank-list" class="w-full p-2 border rounded"></select>
                        <div id="bank-account-details" class="mt-4 text-left bg-white p-3 rounded"></div>
                    </div>
                    <div id="payment-promptpay" class="payment-option active p-4 bg-green-50 rounded-lg text-center">
                        <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</p>
                    </div>
                    <div id="payment-truemoney" class="payment-option p-4 bg-orange-50 rounded-lg text-center">
                        <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÅ‡∏≠‡∏õ TrueMoney Wallet ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p>
                    </div>
                    <div id="payment-linepay" class="payment-option p-4 bg-teal-50 rounded-lg text-center">
                        <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á LINE Pay</p>
                    </div>
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg font-bold">
                        <div class="flex justify-between"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span><span id="co-subtotal">0 ‡∏ø</span></div>
                        <div class="flex justify-between text-xl"><span>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span id="co-total">0 ‡∏ø</span></div>
                    </div>
                    <button id="confirm-order-btn" onclick="placeOrder()" class="mt-4 w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</button>
                </div>
            </div>

            <!-- Confirmation View -->
            <div id="confirmation-view" class="view text-center py-10">
                <!-- ... (same as before) ... -->
                <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                <h2 class="text-2xl font-bold mb-2">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
                <p class="text-gray-600 mb-6">‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≤‡∏á LINE ‡πÅ‡∏•‡πâ‡∏ß</p>
                <p class="mb-2">Order ID: <span id="conf-order-id" class="font-mono"></span></p>
                <button onclick="navigateTo('home-view', true)" class="mt-4 bg-gray-800 text-white py-3 px-6 rounded-lg font-bold">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
            </div>
            
            <!-- History View -->
            <div id="history-view" class="view">
                 <!-- ... (same as before) ... -->
                <h2 class="text-2xl font-bold mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
                <div id="history-container" class="space-y-4"></div>
            </div>
        </main>
    </div>

    <!-- Modal for dynamic content -->
    <div id="custom-modal" class="modal-backdrop"><div class="modal-content" id="modal-content-main"></div></div>
    
    <script>
        // --- CONFIGURATION ---
        const LIFF_ID = "https://liff.line.me/2008007164-WQZgwbkj"; // ‚ùóÔ∏è PASTE YOUR LIFF ID HERE
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyA0tyomy5fsB-twVlyspcsww7Dv6LTc5J2F540KwN9wOonFOkJnRlZIg0Unj_40-sdug/exec"; // ‚ùóÔ∏è PASTE YOUR GOOGLE APPS SCRIPT URL HERE
        const GEMINI_API_KEY = ""; // ‚ùóÔ∏è Leave this empty. Canvas will provide it.
        const PROMPT_PAY_ID = "140000811606998"; 
        const BANK_ACCOUNTS = [ 
            { name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢", value: "kbank", number: "123-4-56789-0", owner: "‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" },
            { name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå", value: "scb", number: "987-6-54321-0", owner: "‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" },
            { name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û", value: "bbl", number: "111-2-33344-5", owner: "‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" },
            { name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢", value: "ktb", number: "555-6-77788-9", owner: "‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" },
            { name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤", value: "bay", number: "246-8-13579-0", owner: "‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" },
            { name: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï", value: "ttb", number: "001-9-88776-5", owner: "‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" },
        ];
        
        // --- APP STATE ---
        let allProducts = [];
        let cart = [];
        let liffProfile = null;
        let viewHistory = ['home-view'];
        
        // --- DOM ELEMENTS ---
        const cartCountEl = document.getElementById('cart-count');
        const headerTitleEl = document.getElementById('header-title');
        const backButtonEl = document.getElementById('back-button');

        // --- VIEW NAVIGATION (same as before) ---
        function navigateTo(viewId, isReset = false) { 
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            if (isReset) { viewHistory = ['home-view']; } 
            else { if(viewHistory[viewHistory.length - 1] !== viewId) viewHistory.push(viewId); }
            updateUI();
        }
        function goBack() { 
            if (viewHistory.length > 1) {
                viewHistory.pop();
                const prevViewId = viewHistory[viewHistory.length - 1];
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(prevViewId).classList.add('active');
                updateUI();
            }
        }
        function updateUI() {
            renderCart();
            updateCartCount();
            updateHeader();
            if (document.getElementById('checkout-view').classList.contains('active')) {
                updateCheckoutSummary();
            }
            if (document.getElementById('history-view').classList.contains('active')) {
                fetchOrderHistory();
            }
        }
        function updateHeader() {
            const currentView = viewHistory[viewHistory.length - 1];
            backButtonEl.classList.toggle('hidden', currentView === 'home-view');
            const viewTitles = { 'home-view': 'Store Shopping', 'cart-view': '‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'checkout-view': '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô', 'confirmation-view': '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠', 'history-view': '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠'};
            headerTitleEl.textContent = viewTitles[currentView] || 'Store Shopping';
        }

        // --- CART LOGIC (same as before) ---
        function addToCart(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) { cartItem.quantity++; } 
            else { cart.push({ ...product, quantity: 1 }); }
            showModalMessage('‚úÖ', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', `"${product.name}" ‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤`);
            updateUI();
        }
        function updateCartQuantity(productId, change) {
            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) {
                cartItem.quantity += change;
                if (cartItem.quantity <= 0) cart = cart.filter(item => item.id !== productId);
            }
            updateUI();
        }
        function renderCart() {
            const container = document.getElementById('cart-items-container');
            const summaryEl = document.getElementById('cart-summary');
            if (cart.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>';
                summaryEl.classList.add('hidden'); return;
            }
            summaryEl.classList.remove('hidden');
            container.innerHTML = cart.map(item => `<div class="flex items-center gap-4 border-b py-4"><img src="${item.image}" class="w-20 h-20 object-cover rounded-md"><div class="flex-grow"><p class="font-bold">${item.name}</p><p class="text-gray-600">${item.price.toLocaleString()} ‡∏ø</p></div><div class="flex items-center gap-2"><button onclick="updateCartQuantity(${item.id}, -1)" class="w-8 h-8 bg-gray-200 rounded-full font-bold">-</button><span>${item.quantity}</span><button onclick="updateCartQuantity(${item.id}, 1)" class="w-8 h-8 bg-gray-200 rounded-full font-bold">+</button></div></div>`).join('');
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('cart-total').textContent = `${total.toLocaleString()} ‡∏ø`;
            document.getElementById('checkout-button').disabled = cart.length === 0;
        }
        function updateCartCount() { cartCountEl.textContent = cart.reduce((sum, item) => sum + item.quantity, 0); }

        // --- CHECKOUT & PAYMENT LOGIC (same as before) ---
        function setupCheckoutPage() {
            const bankList = document.getElementById('co-bank-list');
            bankList.innerHTML = '';
            BANK_ACCOUNTS.forEach(bank => {
                const option = document.createElement('option');
                option.value = bank.value; option.textContent = bank.name;
                bankList.appendChild(option);
            });
            bankList.addEventListener('change', updateBankAccountDetails);
            document.getElementById('co-payment').addEventListener('change', updatePaymentOptionView);
            updateBankAccountDetails(); updatePaymentOptionView();
        }
        function updatePaymentOptionView() {
            const selectedMethod = document.getElementById('co-payment').value;
            document.querySelectorAll('.payment-option').forEach(el => el.classList.remove('active'));
            document.getElementById(`payment-${selectedMethod}`).classList.add('active');
        }
        function updateBankAccountDetails() {
            const selectedBankValue = document.getElementById('co-bank-list').value;
            const bank = BANK_ACCOUNTS.find(b => b.value === selectedBankValue);
            if (bank) { document.getElementById('bank-account-details').innerHTML = `<p><strong>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</strong> ${bank.name}</p><p><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</strong> ${bank.number}</p><p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</strong> ${bank.owner}</p>`; }
        }
        function updateCheckoutSummary() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('co-subtotal').textContent = `${subtotal.toLocaleString()} ‡∏ø`;
            document.getElementById('co-total').textContent = `${subtotal.toLocaleString()} ‡∏ø`;
        }
        async function placeOrder() {
            if (cart.length === 0) return;
            const paymentMethod = document.getElementById('co-payment').value;
            const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const orderData = { lineUserId: liffProfile?.userId, lineDisplayName: liffProfile?.displayName, items: cart.map(item => ({id: item.id, name: item.name, quantity: item.quantity, price: item.price})), shippingAddress: { name: document.getElementById('co-name').value, address: document.getElementById('co-address').value, phone: document.getElementById('co-phone').value }, paymentMethod: paymentMethod, totalAmount: totalAmount };
            if (!orderData.shippingAddress.name || !orderData.shippingAddress.address || !orderData.shippingAddress.phone) { showModalMessage('‚ùóÔ∏è', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); return; }
            showModalMessage('‚è≥', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...');
            const savedOrder = await saveOrderToGAS(orderData);
            hideModal();
            if (!savedOrder || !savedOrder.success) { showModalMessage('‚ùóÔ∏è', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', savedOrder.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ'); return; }
            if (paymentMethod === 'promptpay') { showPromptPayQR(totalAmount, savedOrder.orderId); } 
            else if (paymentMethod === 'bank') { document.getElementById('conf-order-id').textContent = savedOrder.orderId; navigateTo('confirmation-view'); } 
            else if (paymentMethod === 'truemoney') { const trueMoneyURL = `https://www.truemoney.com/payment?ref=${savedOrder.orderId}&amount=${totalAmount}`; liff.openWindow({ url: trueMoneyURL, external: true }); } 
            else if (paymentMethod === 'linepay') { showModalMessage('üí∏', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE Pay', '‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå'); }
            cart = []; updateUI();
        }
        function showPromptPayQR(amount, orderId) { /* ... (same as before) ... */ 
             const generatePayload = (pointOfInitiation, merchantIdentifier, amount) => { const formatMerchantIdentifier = (type, value) => { const tag = type === 'phone' ? '01' : '02'; const formattedValue = type === 'phone' ? `0066${value.substring(1)}` : value; return `29${(tag.length + value.length + 8).toString().padStart(2, '0')}${tag}13${formattedValue}`; }; const payload = [ '000201', `0102${pointOfInitiation}`, formatMerchantIdentifier('phone', merchantIdentifier), '5802TH', `5303764`, `54${amount.toFixed(2).length.toString().padStart(2, '0')}${amount.toFixed(2)}`, '6304' ]; const data = payload.join(''); let crc = 0xFFFF; for (let i = 0; i < data.length; i++) { crc ^= data.charCodeAt(i) << 8; for (let j = 0; j < 8; j++) { crc = (crc & 0x8000) ? (crc << 1) ^ 0x1021 : crc << 1; } } return data + (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0'); }; const qrPayload = generatePayload('12', PROMPT_PAY_ID, amount); const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(qrPayload)}`; const content = `<div class="text-center"><h3 class="text-xl font-bold font-display mb-2">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3><p>Order ID: ${orderId}</p><img src="${qrUrl}" alt="PromptPay QR Code" class="mx-auto my-4 border rounded-lg"><p class="font-bold text-2xl">${amount.toLocaleString()} ‡∏ø</p><p class="text-sm text-gray-500 mt-2">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</p><button onclick="navigateTo('home-view', true); hideModal();" class="mt-4 w-full bg-gray-800 text-white py-3 rounded-lg font-bold">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button></div>`; showModalContent(content);
        }
        async function saveOrderToGAS(orderData) {
            try { const response = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'createOrder', payload: orderData }), headers: { 'Content-Type': 'application/json' } }); return await response.json(); } catch (error) { return { success: false, error: error.message }; }
        }
        
        // --- DATA & HISTORY (same as before) ---
        async function fetchProducts() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('product-grid').innerHTML = '';
             try {
                const response = await fetch(`${GAS_URL}?action=getProducts`);
                const data = await response.json();
                if (data.products && data.products.length > 0) { allProducts = data.products; renderProducts(allProducts); } 
                else { throw new Error('No products found'); }
            } catch (error) { renderProducts([]); showModalMessage('‚ùóÔ∏è', '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ'); } 
            finally { document.getElementById('loading').style.display = 'none'; }
        }
        function renderProducts(products) {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = products.map(p => `
                <div class="bg-white border rounded-lg shadow-sm overflow-hidden flex flex-col">
                    <img src="${p.image}" alt="${p.name}" class="w-full h-40 object-cover">
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="font-semibold text-md truncate flex-grow">${p.name}</h3>
                        <p class="text-purple-600 font-bold mt-1">${p.price.toLocaleString()} ‡∏ø</p>
                        <div class="flex space-x-2 mt-3">
                            <button onclick="addToCart(${p.id})" class="flex-grow bg-gray-800 text-white py-2 rounded-lg text-sm font-bold hover:bg-gray-900">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                            <button onclick="handleStylingAssistant(${p.id})" class="w-10 gemini-button text-white rounded-lg text-sm font-bold flex items-center justify-center" title="‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡πÑ‡∏ï‡∏•‡πå">‚ú®</button>
                        </div>
                    </div>
                </div>`).join('');
        }
        async function fetchOrderHistory() { /* ... (same as before) ... */ }

        // --- GEMINI API INTEGRATION ---
        async function callGeminiApi(prompt) {
            showModalMessage('‚è≥', 'AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    return text;
                } else {
                    throw new Error("No response text from API.");
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                showModalMessage('‚ùóÔ∏è', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ');
                return null;
            }
        }

        function showPersonalShopperModal() {
            const content = `
                <div class="text-center">
                    <h3 class="text-2xl font-bold font-display mb-4">‚ú® ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                    <p class="text-gray-600 mb-4">‡∏ö‡∏≠‡∏Å‡πÄ‡∏£‡∏≤‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≠‡∏á‡∏´‡∏≤‡∏≠‡∏∞‡πÑ‡∏£ ‡πÅ‡∏•‡πâ‡∏ß AI ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì</p>
                    <textarea id="shopper-input" class="w-full h-24 p-2 border rounded" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢, ‡∏ä‡∏∏‡∏î‡πÑ‡∏õ‡∏ó‡∏∞‡πÄ‡∏•, ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏°‡∏¥‡∏ô‡∏¥‡∏°‡∏≠‡∏•..."></textarea>
                    <button onclick="handlePersonalShopperSubmit()" class="mt-4 w-full gemini-button text-white py-3 rounded-lg font-bold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢</button>
                </div>
            `;
            showModalContent(content);
        }

        async function handlePersonalShopperSubmit() {
            const userInput = document.getElementById('shopper-input').value;
            if (!userInput.trim()) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤");
                return;
            }

            const productListText = allProducts.map((p, i) => `${i + 1}. ‡∏ä‡∏∑‡πà‡∏≠: ${p.name}, ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${p.description}, ‡∏£‡∏≤‡∏Ñ‡∏≤: ${p.price} ‡∏ö‡∏≤‡∏ó`).join('\n');
            const prompt = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á AI ‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô 'Store Shopping' ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô:\n${productListText}\n\n‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏ß‡πà‡∏≤: "${userInput}"\n\n‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î 3 ‡∏ä‡∏¥‡πâ‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡πÑ‡∏°‡∏ñ‡∏∂‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏¥‡πâ‡∏ô‡∏ô‡∏±‡πâ‡∏ô ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢`;

            const result = await callGeminiApi(prompt);
            if (result) {
                showModalMessage('‚ú®', '‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI', result);
            }
        }

        async function handleStylingAssistant(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            const prompt = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏™‡πÑ‡∏ï‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠ '${product.name}' (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${product.description}) ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô 3 ‡∏Ç‡πâ‡∏≠‡πÅ‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

            const result = await callGeminiApi(prompt);
            if (result) {
                showModalMessage('üí°', `‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "${product.name}"`, result);
            }
        }

        // --- MODAL LOGIC ---
        const modal = document.getElementById('custom-modal');
        function showModalMessage(icon, title, message) {
            const content = `<div class="text-left"><div class="text-center text-5xl mb-4">${icon}</div><h3 class="text-center text-2xl font-bold font-display mb-2">${title}</h3><div class="text-gray-600 mb-6 whitespace-pre-wrap">${message.replace(/\n/g, '<br>')}</div><button onclick="hideModal()" class="mt-4 w-full bg-gray-800 text-white py-3 rounded-lg font-bold">‡∏õ‡∏¥‡∏î</button></div>`;
            showModalContent(content);
        }
        function showModalContent(htmlContent) {
            document.getElementById('modal-content-main').innerHTML = htmlContent;
            modal.classList.add('show');
        }
        function hideModal() { modal.classList.remove('show'); }
        
        // --- LIFF & APP INITIALIZATION ---
        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login({ redirectUri: window.location.href }); return;
                }
                liffProfile = await liff.getProfile();
                document.getElementById('co-name').value = liffProfile.displayName;
            } catch (error) { showModalMessage('‚ùóÔ∏è', 'LIFF Error', `Failed to initialize LIFF: ${error.message}`); }
            await fetchProducts();
            setupCheckoutPage();
            updateUI();
        }
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>

